app-id: net.retrodeck.retrodeck
runtime: org.kde.Platform
runtime-version: 5.15-21.08
#runtime-version: 6.3                        # bumped because of pcsx2-qt
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.llvm14    # Needed for rpcs3
  #- org.freedesktop.Sdk.Extension.dotnet6   # Needed for Ryujinx - Removed, check if it's not breaking something else
base: io.qt.qtwebengine.BaseApp             # Needed for Yuzu
base-version: 5.15-21.08                    # Needed for Yuzu
command: retrodeck.sh

finish-args:
  - --socket=x11
  #- --socket=wayland
  - --socket=pulseaudio
  - --share=ipc
  - --share=network
  - --device=all
  - --filesystem=home # Needed to be able to relocate / remove / create symlink at ~/retrodeck
  - --filesystem=/run/media
  - --filesystem=/media
  - --allow=multiarch
  - --talk-name=org.freedesktop.ScreenSaver
  - --talk-name=org.freedesktop.PowerManagement.Inhibit
  - --talk-name=org.freedesktop.login1.Manager
  - --talk-name=org.freedesktop.Flatpak
  - --filesystem=xdg-run/app/com.discordapp.Discord:create
  # Yuzu
  # - --filesystem=home:ro # This may break Yuzu, let's see
  # - --filesystem=/run/media:ro
  # Dolphin
  - --allow=bluetooth
  #- --env=QT_QPA_PLATFORM=xcb #not sure if this will break something
  # rpcs3
  #- --socket=fallback-x11

cleanup:
  # ES-DE
  - /include
  - /share/ffmpeg
  - /lib/cmake
  - /lib/pkgconfig
  # Yuzu
  - /include
  - /bin/glslangValidator
  - /bin/zip*
  - /bin/zstd*
  - /lib/pkg-config
  - /share/doc
  - /share/man
  - /src
  - '*.a'
  - '*.la'
  # XMLSTARLET
  - /lib/debug
  - /share/runtime
cleanup-commands:
  # Yuzu
  - /app/cleanup-BaseApp.sh

modules:

  # Ryujinx - START
  # https://ryujinx.org/download

  - name: Ryujinx
    buildsystem: simple
    build-commands:
      - |
        ls -lah #DEBUG
        tar -zxvf ryujinx-1.1.685-linux_x64.tar.gz
        mv -v publish ${FLATPAK_DEST}/ryujinx
        ls -lah ${FLATPAK_DEST} #DEBUG
        ln -s ${FLATPAK_DEST}/ryujinx/Ryujinx /app/bin/Ryujinx
        ls -lah ${FLATPAK_DEST}/ryujinx/Ryujinx #DEBUG
        ls -lah /app/bin/Ryujinx #DEBUG
    sources:
      - type: file
        url: https://github.com/Ryujinx/release-channel-master/releases/download/1.1.685/ryujinx-1.1.685-linux_x64.tar.gz
        sha256: bc4d7076106d7aa59c3a3ea22b83c553e5fa1a897815831adcf18cc13d729e15
