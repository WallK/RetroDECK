app-id: net.retrodeck.retrodeck
runtime: org.kde.Platform
runtime-version: 5.15-22.08
#runtime-version: 6.3                        # bumped because of pcsx2-qt
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.llvm14    # Needed for rpcs3
  #- org.freedesktop.Sdk.Extension.dotnet6   # Needed for Ryujinx - Removed, check if it's not breaking something else
add-extensions:                             # Needed for RYUJINX
  org.freedesktop.Platform.ffmpeg-full:
    version: '22.08'
    directory: lib/ffmpeg
    add-ld-path: .                          # /Needed for RYUJINX
base: io.qt.qtwebengine.BaseApp             # Needed for Yuzu
base-version: 5.15-22.08                    # Needed for Yuzu
command: retrodeck.sh

finish-args:
  - --socket=x11
  #- --socket=wayland
  - --socket=pulseaudio
  - --share=ipc
  - --share=network
  - --device=all
  - --filesystem=home # Needed to be able to relocate / remove / create symlink at ~/retrodeck
  - --filesystem=/run/media
  - --filesystem=/media
  - --allow=multiarch
  - --talk-name=org.freedesktop.ScreenSaver
  - --talk-name=org.freedesktop.PowerManagement.Inhibit
  - --talk-name=org.freedesktop.login1.Manager
  - --talk-name=org.freedesktop.Flatpak
  - --filesystem=xdg-run/app/com.discordapp.Discord:create
  # Yuzu
  # - --filesystem=home:ro # This may break Yuzu, let's see
  # - --filesystem=/run/media:ro
  # Dolphin
  - --allow=bluetooth
  #- --env=QT_QPA_PLATFORM=xcb #not sure if this will break something
  # rpcs3
  #- --socket=fallback-x11

cleanup:
  # ES-DE
  - /include
  - /share/ffmpeg
  - /lib/cmake
  - /lib/pkgconfig
  # Yuzu
  - /include
  - /bin/glslangValidator
  - /bin/zip*
  - /bin/zstd*
  - /lib/pkg-config
  - /share/doc
  - /share/man
  - /src
  - '*.a'
  - '*.la'
  # XMLSTARLET
  - /lib/debug
  - /share/runtime
cleanup-commands:
  # Yuzu
  - /app/cleanup-BaseApp.sh

modules:

# Ryujinx - START
# https://github.com/flathub/org.ryujinx.Ryujinx
# when moving this module on the real branch mgirate:
# rd-submodules/ryujinx/ryujinx-wrapper
# rd-submodules/ryujinx/nuget_sources.json

- name: Ryujinx
  buildsystem: simple
  build-options:
    no-debuginfo: true
    no-debuginfo-compression: true
    strip: false
    arch:
      x86_64:
        env:
          RUNTIME: linux-x64
    env:
      PKG_CONFIG_PATH: /app/lib/pkgconfig:/app/share/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig
      DOTNET_CLI_TELEMETRY_OPTOUT: 'true'
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 'true'
      RYUJINX_VERSION: 1.1.708
      RYUJINX_TARGET_RELEASE_CHANNEL_OWNER: flathub
      RYUJINX_TARGET_RELEASE_CHANNEL_REPO: org.ryujinx.Ryujinx
      RYUJINX_TARGET_RELEASE_CHANNEL_NAME: master
  build-commands:
  - |
    export PATH=$PATH:/run/build/Ryujinx/dotnet-sdk
    export RYUJINX_GIT_SHORT_HASH=$(git rev-parse --short HEAD)
    export RUNTIME_FRAMEWORK_VERSION=$(find nuget-sources -name 'microsoft.netcore.app.host.linux-x64.*' | grep -oP '(\d.\d.\d+.nupkg)' | grep -oP '(\d.\d.\d+)')
    sed -r --in-place "s/\%\%RYUJINX_BUILD_VERSION\%\%/$RYUJINX_VERSION/g;" Ryujinx.Common/ReleaseInformation.cs
    sed -r --in-place "s/\%\%RYUJINX_BUILD_GIT_HASH\%\%/$RYUJINX_GIT_SHORT_HASH/g;" Ryujinx.Common/ReleaseInformation.cs
    sed -r --in-place "s/\%\%RYUJINX_TARGET_RELEASE_CHANNEL_NAME\%\%/$RYUJINX_TARGET_RELEASE_CHANNEL_NAME/g;" Ryujinx.Common/ReleaseInformation.cs
    sed -r --in-place "s/\%\%RYUJINX_TARGET_RELEASE_CHANNEL_OWNER\%\%/$RYUJINX_TARGET_RELEASE_CHANNEL_OWNER/g;" Ryujinx.Common/ReleaseInformation.cs
    sed -r --in-place "s/\%\%RYUJINX_TARGET_RELEASE_CHANNEL_REPO\%\%/$RYUJINX_TARGET_RELEASE_CHANNEL_REPO/g;" Ryujinx.Common/ReleaseInformation.cs
    mkdir -p /app/bin
    dotnet publish -c Release -r $RUNTIME /p:DebugType=embedded Ryujinx /p:Version=$RYUJINX_VERSION /p:SourceRevisionId=$RYUJINX_GIT_SHORT_HASH /p:ExtraDefineConstants="DISABLE_UPDATER%2CFORCE_EXTERNAL_BASE_DIR" /p:RuntimeFrameworkVersion=$RUNTIME_FRAMEWORK_VERSION --self-contained --source nuget-sources
    if [ $? -ne 0 ]; then
        exit 1;
    fi;
    cp -r --remove-destination /run/build/Ryujinx/Ryujinx/bin/Release/net7.0/$RUNTIME/publish/* /app/bin/
    mkdir -p /app/lib/ffmpeg
    ln -s /usr/lib/x86_64-linux-gnu/libX11.so.6 /app/lib/libX11.so
    install -Dm755 ryujinx-wrapper /app/bin/ryujinx-wrapper
    install -Dm644 distribution/misc/Logo.svg /app/share/icons/hicolor/scalable/apps/ryujinx.svg
  sources:
  - type: archive
    only-arches:
    - x86_64
    dest: dotnet-sdk
    url: https://dotnetcli.azureedge.net/dotnet/Sdk/7.0.202/dotnet-sdk-7.0.202-linux-x64.tar.gz
    sha256: 405f15e437582be260460f48eda9dfe613fd87b2557667f20d6ecfa34b09c221
    x-checker-data:
      type: rotating-url
      url: https://aka.ms/dotnet/7.0/dotnet-sdk-linux-x64.tar.gz
      pattern: https://dotnetcli.azureedge.net/dotnet/Sdk/^([\d\.a-z-]+)$/dotnet-sdk-^([\d\.a-z-]+)$-linux-x64.tar.gz
  - rd-submodules/ryujinx/nuget_sources.json
  - type: git
    url: https://github.com/Ryujinx/Ryujinx.git
    commit: 4c3f09644a033dbf70258c4c0e5a848263b16bbd
  - type: file
    path: rd-submodules/ryujinx/ryujinx-wrapper

# Ryujinx - END
